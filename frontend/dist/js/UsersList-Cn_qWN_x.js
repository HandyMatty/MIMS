import{r as t,v as xe,w as pe,F as p,j as e,M as W,m as fe,B as y,i as h,I as Z,c as Ae,d as Me,e as Ie,bh as De,f as V,bH as Pe,bl as Fe,q as Ne,R as Te,g as Ee,al as ke}from"./index-D_DjqwU6.js";import{f as ne,u as Oe,a as $e,g as qe,b as Qe,d as Le,c as Ve}from"./Users-CjSNJtwJ.js";import{i as ze,g as Be,a as _e,u as ce,m as We,S as Ye}from"./cacheUtils-rgXBj3X0.js";import{i as ue}from"./offlineUtils-CjPJFgFK.js";import{u as Ke,F as Ge}from"./index-GL6TR608.js";import{T as de}from"./index-BlUNoHI2.js";import{P as He}from"./Pagination-B3MLnmFW.js";import"./index-DG92omOn.js";import"./useBubbleLock-BNMpLRc-.js";import"./index-CYk8aGXX.js";import"./index-CRHxdFZf.js";var Je={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M866.9 169.9L527.1 54.1C523 52.7 517.5 52 512 52s-11 .7-15.1 2.1L157.1 169.9c-8.3 2.8-15.1 12.4-15.1 21.2v482.4c0 8.8 5.7 20.4 12.6 25.9L499.3 968c3.5 2.7 8 4.1 12.6 4.1s9.2-1.4 12.6-4.1l344.7-268.6c6.9-5.4 12.6-17 12.6-25.9V191.1c.2-8.8-6.6-18.3-14.9-21.2zM810 654.3L512 886.5 214 654.3V226.7l298-101.6 298 101.6v427.6zM402.9 528.8l-77.5 77.5a8.03 8.03 0 000 11.3l34 34c3.1 3.1 8.2 3.1 11.3 0l77.5-77.5c55.7 35.1 130.1 28.4 178.6-20.1 56.3-56.3 56.3-147.5 0-203.8-56.3-56.3-147.5-56.3-203.8 0-48.5 48.5-55.2 123-20.1 178.6zm65.4-133.3c31.3-31.3 82-31.3 113.2 0 31.3 31.3 31.3 82 0 113.2-31.3 31.3-82 31.3-113.2 0s-31.3-81.9 0-113.2z"}}]},name:"security-scan",theme:"outlined"},Xe=function(l,i){return t.createElement(xe,pe({},l,{ref:i,icon:Je}))},Ze=t.forwardRef(Xe),es={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M678.3 642.4c24.2-13 51.9-20.4 81.4-20.4h.1c3 0 4.4-3.6 2.2-5.6a371.67 371.67 0 00-103.7-65.8c-.4-.2-.8-.3-1.2-.5C719.2 505 759.6 431.7 759.6 349c0-137-110.8-248-247.5-248S264.7 212 264.7 349c0 82.7 40.4 156 102.6 201.1-.4.2-.8.3-1.2.5-44.7 18.9-84.8 46-119.3 80.6a373.42 373.42 0 00-80.4 119.5A373.6 373.6 0 00137 888.8a8 8 0 008 8.2h59.9c4.3 0 7.9-3.5 8-7.8 2-77.2 32.9-149.5 87.6-204.3C357 628.2 432.2 597 512.2 597c56.7 0 111.1 15.7 158 45.1a8.1 8.1 0 008.1.3zM512.2 521c-45.8 0-88.9-17.9-121.4-50.4A171.2 171.2 0 01340.5 349c0-45.9 17.9-89.1 50.3-121.6S466.3 177 512.2 177s88.9 17.9 121.4 50.4A171.2 171.2 0 01683.9 349c0 45.9-17.9 89.1-50.3 121.6C601.1 503.1 558 521 512.2 521zM880 759h-84v-84c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v84h-84c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h84v84c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-84h84c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"}}]},name:"user-add",theme:"outlined"},ss=function(l,i){return t.createElement(xe,pe({},l,{ref:i,icon:es}))},ts=t.forwardRef(ss);const{Text:me}=fe,{Option:rs}=h,as=["SOD","CID","GAD","HRD","AFD","EOD","BDO"],ns=({isAddModalVisible:m,setIsAddModalVisible:l,handleAddUser:i,temporaryPassword:j,isPasswordModalVisible:q,setIsPasswordModalVisible:S,isSecurityQuestionModalVisible:k,setIsSecurityQuestionModalVisible:x,securityQuestions:v,handleChangeSecurityQuestion:M,currentUserSecurityQuestion:w,isRoleModalVisible:b,setIsRoleModalVisible:g,currentUserRole:I,handleRoleUpdate:z})=>{const[Q,C]=t.useState(!1),[O]=p.useForm(),[D]=p.useForm(),[P]=p.useForm(),[F,$]=t.useState(null);return e.jsxs(e.Fragment,{children:[e.jsx(W,{title:"Security Question",open:k,centered:!0,onCancel:()=>{x(!1),C(!1),D.resetFields()},footer:null,children:Q?e.jsxs(p,{form:D,onFinish:o=>{M(o),C(!1),x(!1),D.resetFields()},children:[e.jsx(p.Item,{name:"security_question",label:"Security Question",rules:[{required:!0,message:"Please select a security question!"}],children:e.jsx(h,{placeholder:"Select a security question",children:v.map((o,U)=>e.jsx(h.Option,{value:o,children:o},U))})}),e.jsx(p.Item,{name:"security_answer",label:"Security Answer",rules:[{required:!0,message:"Please provide an answer!"}],children:e.jsx(Z.Password,{placeholder:"Enter your answer"})}),e.jsxs("div",{className:"w-auto flex justify-self-end mt-5",children:[e.jsx(y,{onClick:()=>{D.resetFields(),C(!1)},className:"custom-button-cancel",children:"Cancel"}),e.jsx(y,{type:"primary",htmlType:"submit",className:"custom-button ml-2",children:"Save"})]})]}):e.jsx(e.Fragment,{children:w?e.jsxs(e.Fragment,{children:[e.jsxs(me,{children:["Current Security Question: ",e.jsx("strong",{children:w})]}),e.jsx(y,{type:"primary",onClick:()=>C(!0),className:"w-auto flex justify-self-end mt-5 custom-button",children:"Change Security Question"})]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{children:"No security question set for this user."}),e.jsx(y,{type:"primary",onClick:()=>C(!0),className:"w-auto flex justify-self-end mt-5 custom-button",children:"Add Security Question"})]})})}),e.jsx(W,{title:"Add User",open:m,centered:!0,onCancel:()=>{l(!1),O.resetFields(),$(null)},footer:null,children:e.jsxs(p,{form:O,onFinish:o=>{i(o),O.resetFields(),$(null),l(!1)},children:[e.jsx(p.Item,{name:"username",label:"Username",rules:[{required:!0,message:"Please input the username!"}],children:e.jsx(Z,{placeholder:"Enter the username"})}),e.jsx(p.Item,{name:"department",label:"Department",rules:[{required:!0,message:"Please select a department!"}],children:e.jsx(h,{placeholder:"Select Department",children:as.map(o=>e.jsx(rs,{value:o,children:o},o))})}),e.jsx(p.Item,{name:"role",label:"Role",rules:[{required:!0,message:"Please select a role!"}],children:e.jsxs(h,{placeholder:"Select a role",onChange:o=>$(o),children:[e.jsx(h.Option,{value:"user",children:"User"}),e.jsx(h.Option,{value:"admin",children:"Admin"}),e.jsx(h.Option,{value:"guest",children:"Guest"})]})}),F!=="guest"&&e.jsxs(e.Fragment,{children:[e.jsx(p.Item,{name:"security_question",label:"Security Question",rules:[{required:!0,message:"Please select a security question!"}],children:e.jsx(h,{placeholder:"Select a security question",children:v.map((o,U)=>e.jsx(h.Option,{value:o,children:o},U))})}),e.jsx(p.Item,{name:"security_answer",label:"Security Answer",rules:[{required:!0,message:"Please provide an answer!"}],children:e.jsx(Z.Password,{placeholder:"Enter your answer"})})]}),e.jsx(y,{type:"primary",htmlType:"submit",className:"custom-button text-xs justify-self-end flex",children:"Add User"})]})}),e.jsx(W,{title:"Temporary Password",open:q,centered:!0,onCancel:()=>S(!1),footer:null,children:e.jsxs("p",{children:["Your temporary password is: ",j]})}),e.jsx(W,{title:"Edit Role",open:b,centered:!0,onCancel:()=>{g(!1),P.resetFields()},footer:null,afterOpenChange:o=>{o&&P.setFieldsValue({role:I})},children:e.jsxs(p,{form:P,onFinish:o=>{z(o),P.resetFields(),g(!1)},children:[e.jsx(p.Item,{name:"role",label:"Role",rules:[{required:!0,message:"Please select a role!"}],children:e.jsxs(h,{children:[e.jsx(h.Option,{value:"user",children:"User"}),e.jsx(h.Option,{value:"admin",children:"Admin"}),e.jsx(h.Option,{value:"guest",children:"Guest"})]})}),e.jsx(y,{type:"primary",htmlType:"submit",className:"flex justify-self-end custom-button",children:"Update Role"})]})})]})},os=async(m,l)=>{try{const i={userId:m,password:l};return(await Ae.post("/reset_password.php",i)).data}catch(i){throw console.error("Reset Password API Error:",i),i}},he=()=>{const m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let l="";for(let i=0;i<8;i++)l+=m.charAt(Math.floor(Math.random()*m.length));return l},ls=()=>{const[m,l]=t.useState([]),[i,j]=t.useState([]),[q,S]=t.useState(""),[k,x]=t.useState([]),[v,M]=t.useState(!1),[w,b]=t.useState(!1),[g,I]=t.useState(!1),[z,Q]=t.useState(""),[C,O]=t.useState([]),[D,P]=t.useState(null),[F,$]=t.useState(null),[o,U]=t.useState(1),[Y,K]=t.useState(5),[ee,oe]=t.useState(!0),[se,L]=t.useState(!1),[G,B]=t.useState(null),[N,H]=t.useState(null),[J,R]=t.useState(!1),[te,X]=t.useState(!1),[re,_]=t.useState(null),{logUserActivity:T}=Me(),{logUserNotification:E}=Ie(),{message:c,modal:a}=De.useApp(),n=t.useRef(null),f="users",ye=async s=>{R(!0);try{const r=await Ve(N,s.role);r.success?(c.success(r.message||"Role updated successfully"),L(!1),l(u=>u.map(d=>d.id===N?{...d,role:s.role}:d)),x(u=>u.map(d=>d.id===N?{...d,role:s.role}:d)),T("Admin","User Management",`Updated the role of user with ID: "${N}" to "${s.role}"`),E("User Management",`You have updated the role of user with ID: "${N}" to "${s.role}"`)):c.error(r.message||"Failed to update role")}catch{c.error("An error occurred while updating the role")}finally{R(!1)}},we=async(s,r)=>{try{const u=await Oe(s,r);u.success?(c.success("Department updated successfully"),l(d=>d.map(A=>A.id===s?{...A,department:r}:A)),x(d=>d.map(A=>A.id===s?{...A,department:r}:A)),T("Admin","User Management",`Updated the department of user with ID: "${s}" to "${r}"`),E("User Management",`You have updated the department of user with ID: "${s}" to "${r}"`)):c.error(u.message||"Failed to update department")}catch(u){console.error("Error updating department:",u),c.error("Failed to update department")}},ge=s=>{B(s.role),H(s.id),L(!0)};t.useEffect(()=>{O(["What is your mother's maiden name?","What was the name of your first pet?","What is your favorite color?","In what city were you born?","What is the name of your first school?","What is your favorite movie?","Who is your favorite author?","What is the name of your best friend?","What is your dream job?","Where did you go on your last vacation?"])},[]);const ae=t.useCallback(async(s=!1)=>{try{if(await ue()){console.warn("Cannot refresh users while offline");return}if(X(!0),ze(f,s)){const u=Be(f);l(u.users),x(u.users),_(_e(f));return}const r=await ne();ce(f,r),l(r.users),x(r.users),_(Date.now())}catch(r){console.error("Failed to load users data:",r)}finally{X(!1)}},[]),le=t.useCallback(()=>{n.current&&clearInterval(n.current),n.current=setInterval(async()=>{try{if(await ue())return;const s=await ne();ce(f,s),l(s.users),x(s.users),_(Date.now())}catch(s){console.warn("Background sync failed:",s),We(f)}},Ye)},[]),ie=t.useCallback(()=>{n.current&&(clearInterval(n.current),n.current=null)},[]);t.useEffect(()=>(ae(),le(),()=>ie()),[ae,le,ie]);const je=s=>{const r=s.target.value;S(r);const u=m.filter(d=>Object.values(d).some(A=>String(A).toLowerCase().includes(r.toLowerCase())));x(u)},Se=(s,r)=>{U(s),K(r)},be=()=>{W.confirm({title:"Confirm Deletion",content:`Are you sure you want to delete ${i.length} user(s)? This action cannot be undone.`,okText:"Yes, Delete",cancelText:"Cancel",centered:!0,onOk:async()=>{try{const s=await Le(i);if(s.success){c.success(s.message||"Users deleted successfully");const r=m.filter(u=>!i.includes(u.id));l(r),x(r),j([]),T("Admin","User Management",`Deleted ${i.length} user(s)`),E("User Management",`You have deleted ${i.length} user(s)`)}else c.error(s.message||"Failed to delete users")}catch(s){console.error("Error deleting users:",s),c.error("Failed to delete users")}}})},ve=async s=>{if(m.some(d=>d.username.toLowerCase()===s.username.toLowerCase())){c.error("Username already exists. Please choose a different username.");return}const u=he();try{await Qe({...s,password:u}),c.success("User added successfully"),Q(u),M(!1),b(!0);const d=await ne();l(d.users),x(d.users),T("Admin","User Management",`Added a new user with username: "${s.username}"`),E("User Management",`You have added a new user with username: "${s.username}"`)}catch(d){console.error("Error adding user:",d),c.error("Failed to add user")}},Ce=s=>{a.confirm({title:"Are you sure you want to reset the password?",content:"This action will reset the user's password to a temporary one.",okText:"Yes",cancelText:"No",centered:!0,okButtonProps:{className:"custom-button"},cancelButtonProps:{className:"custom-button-cancel"},onOk:async()=>{const r=he();try{await os(s,r),c.success("Password reset successfully"),Q(r),b(!0),T("Admin","User Management",`Reset the password for user with ID: "${s}"`),E("User Management",`You have reset the password for user with ID: "${s}"`)}catch(u){console.error("Error resetting password:",u),c.error("Failed to reset password")}}})},Ue=async s=>{try{const r=await qe(s);r.success?(P(r.security_question),$(s),I(!0)):c.error("Failed to fetch security question")}catch(r){console.error("Error fetching security question:",r),c.error("Failed to fetch security question")}},Re=async s=>{try{const r=await $e(F,s.security_question,s.security_answer);r.success?(c.success("Security question updated successfully."),I(!1),T("Admin","User Management",`Updated the security question for user with ID: "${F}"`),E("User Management",`You have updated the security question for user with ID: "${F}"`)):c.error(r.message||"Failed to update security question.")}catch(r){console.error("Error updating security question:",r),c.error("Failed to update security question.")}};return t.useCallback(()=>{S(""),U(1),K(5),j([])},[]),{users:m,setUsers:l,selectedRowKeys:i,setSelectedRowKeys:j,searchText:q,setSearchText:S,filteredData:k,setFilteredData:x,isAddModalVisible:v,setIsAddModalVisible:M,isPasswordModalVisible:w,setIsPasswordModalVisible:b,isSecurityQuestionModalVisible:g,setIsSecurityQuestionModalVisible:I,temporaryPassword:z,securityQuestions:C,currentUserSecurityQuestion:D,currentUserId:F,currentPage:o,pageSize:Y,loading:ee,isRoleModalVisible:se,setIsRoleModalVisible:L,currentUserRole:G,setCurrentUserRole:B,currentUserIdForRole:N,setCurrentUserIdForRole:H,loadingRoleUpdate:J,handleRoleUpdate:ye,showEditRoleModal:ge,onSearch:je,handlePageChange:Se,handleBatchDelete:be,handleAddUser:ve,handleResetPassword:Ce,handleSecurityQuestion:Ue,handleChangeSecurityQuestion:Re,handleDepartmentUpdate:we,refreshUsers:ae,isRefreshing:te,lastSyncTime:re}},{Text:is}=fe,{Option:cs}=h,us=["SOD","CID","GAD","HRD","AFD","EOD","BDO"],bs=({usersData:m=[],loading:l=!1,error:i=null,onRefresh:j,lastSyncTime:q})=>{const S=Ke({maxWidth:639}),[k,x]=t.useState([]),[v,M]=t.useState(""),[w,b]=t.useState(1),[g,I]=t.useState(5),{isAddModalVisible:z,isPasswordModalVisible:Q,isSecurityQuestionModalVisible:C,temporaryPassword:O,securityQuestions:D,currentUserSecurityQuestion:P,isRoleModalVisible:F,setIsRoleModalVisible:$,currentUserRole:o,loadingRoleUpdate:U,setIsAddModalVisible:Y,setIsPasswordModalVisible:K,setIsSecurityQuestionModalVisible:ee,handleBatchDelete:oe,handleAddUser:se,handleResetPassword:L,handleSecurityQuestion:G,showEditRoleModal:B,handleRoleUpdate:N,handleChangeSecurityQuestion:H,handleDepartmentUpdate:J}=ls(),R=t.useMemo(()=>v?m.filter(a=>Object.values(a).some(n=>String(n).toLowerCase().includes(v.toLowerCase()))):m,[m,v]),te=t.useMemo(()=>R.slice((w-1)*g,w*g),[R,w,g]),X=t.useCallback(a=>{const n=a.target.value;M(n),b(1)},[]),re=t.useCallback((a,n)=>{b(a),I(n)},[]),_=t.useCallback(()=>{M(""),b(1),I(5),x([]),j&&j()},[j]);t.useCallback(()=>{M(""),b(1)},[]);const T=t.useMemo(()=>[{title:"ID",dataIndex:"id",key:"id",width:"100px",responsive:["sm"],sorter:(a,n)=>a.id-n.id,className:"text-xs overflow-auto"},{title:"Username",dataIndex:"username",key:"username",width:"120px",className:"text-xs overflow-auto",sorter:(a,n)=>a.username.localeCompare(n.username)},{title:"Department",dataIndex:"department",key:"department",width:"140px",className:"text-xs overflow-auto text-wrap",sorter:(a,n)=>a.department.localeCompare(n.department),render:(a,n)=>e.jsx(h,{value:a,style:{width:"auto"},size:S?"small":"middle",onChange:f=>J(n.id,f),disabled:n.role==="guest",className:"transparent-select",children:us.map(f=>e.jsx(cs,{value:f,children:f},f))})},{title:"Role",dataIndex:"role",key:"role",className:"text-xs overflow-auto",responsive:["sm"],width:"120px",render:a=>e.jsx(de,{color:a==="admin"?"blue":a==="user"?"green":"orange",children:a})},{title:"Status",dataIndex:"status",key:"status",responsive:["sm"],width:"120px",className:"text-xs overflow-auto",render:a=>e.jsx(de,{color:a==="Active"?"green":"red",children:a})},{title:"Actions",key:"actions",className:"text-xs overflow-auto",width:"120px",render:(a,n)=>e.jsxs("div",{children:[e.jsx(V,{title:"Reset Password",children:e.jsx(y,{icon:e.jsx(Pe,{}),type:"text",onClick:()=>L(n.id)})}),n.role!=="guest"&&e.jsx(V,{title:"Security Question",children:e.jsx(y,{icon:e.jsx(Ze,{}),type:"text",onClick:()=>G(n.id)})}),e.jsx(V,{title:"Edit Role",children:e.jsx(y,{icon:e.jsx(Fe,{}),type:"text",onClick:()=>B(n),loading:U})})]})}],[S,J,L,G,B,U]),E=t.useMemo(()=>({selectedRowKeys:k,onChange:a=>x(a),preserveSelectedRowKeys:!0}),[k]),c=t.useMemo(()=>S?{expandedRowRender:a=>e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[e.jsx("b",{children:"ID:"})," ",a.id]}),e.jsxs("div",{children:[e.jsx("b",{children:"Username:"})," ",a.username]}),e.jsxs("div",{children:[e.jsx("b",{children:"Department:"})," ",a.department]}),e.jsxs("div",{children:[e.jsx("b",{children:"Role:"})," ",a.role]}),e.jsxs("div",{children:[e.jsx("b",{children:"Status:"})," ",a.status]})]}),rowExpandable:()=>!0}:void 0,[S]);return e.jsxs(Ne,{title:e.jsx("span",{className:"text-lgi sm:text-sm md:text-md lg:text-lgi xl:text-xl font-bold flex justify-center",children:"ALL USERS"}),className:"flex flex-col w-full mx-auto bg-[#A8E1C5] rounded-xl shadow border-none",children:[e.jsxs("div",{className:"flex justify-start items-center mb-4 space-x-2",children:[e.jsx(Z,{placeholder:"Search users...",prefix:e.jsx(Te,{}),value:v,onChange:X,className:"w-auto text-xs border border-black",allowClear:!0}),e.jsx(V,{title:"Add User",children:e.jsx(y,{icon:e.jsx(ts,{}),type:"text",onClick:()=>Y(!0)})}),e.jsx(V,{title:"Delete",children:e.jsx(y,{type:"link",icon:e.jsx(Ee,{}),danger:!0,disabled:k.length===0,onClick:oe})}),e.jsx(V,{title:"Refresh",children:e.jsx(y,{type:"text",icon:e.jsx(ke,{}),onClick:_,className:"w-auto text-xs",size:"small"})})]}),e.jsx("div",{className:"w-auto overflow-x-auto",children:e.jsx(Ge,{columns:T,dataSource:te,pagination:!1,bordered:!0,rowKey:"id",rowSelection:E,className:"w-auto",loading:l,responsive:["xs","sm","md","lg","xl"],scroll:{x:"max-content",y:300},expandable:c})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between mt-5 space-y-2 sm:space-y-0",children:[e.jsxs("div",{className:"w-full flex flex-col items-center sm:items-start",children:[e.jsxs(is,{style:{color:"#072C1C"},className:"w-full text-xs text-wrap text-center sm:text-left",children:["Showing ",Math.min((w-1)*g+1,R.length)," to"," ",Math.min(w*g,R.length)," of ",R.length," entries"]}),q&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 text-center sm:text-left",children:["Last synced: ",new Date(q).toLocaleTimeString()]})]}),e.jsx("div",{className:"w-full flex justify-center sm:justify-end",children:e.jsx(He,{current:w,pageSize:g,total:R.length,showSizeChanger:!0,pageSizeOptions:["5","10","15"],onChange:re,className:"text-xs",responsive:!0})})]}),e.jsx(ns,{isAddModalVisible:z,setIsAddModalVisible:Y,handleAddUser:se,temporaryPassword:O,isPasswordModalVisible:Q,setIsPasswordModalVisible:K,isSecurityQuestionModalVisible:C,setIsSecurityQuestionModalVisible:ee,securityQuestions:D,handleChangeSecurityQuestion:H,currentUserSecurityQuestion:P,isRoleModalVisible:F,setIsRoleModalVisible:$,currentUserRole:o,handleRoleUpdate:N})]})};export{bs as default};
